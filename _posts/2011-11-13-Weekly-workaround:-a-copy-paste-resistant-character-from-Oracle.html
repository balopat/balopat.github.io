---           
layout: post
title: Weekly workaround: a copy-paste resistant character from Oracle
date: 2011-11-13 08:27:00 UTC
updated: 2013-12-14 19:44:55 UTC
comments: false
categories: 4K clob jdbc oracle prefetch string weekly workaround workaround xmltype
---
 
<p>Software: Oracle&nbsp;with XML DB&nbsp;<br />Version: 11.2.0.2&nbsp;</p><br /><br/><p>I am starting to get used to the fact that the Oracle JDBC implementation always suprises me<br />with some truly peculiar behaviour. Have you encountered a situation when you have a copy paste resistant character in your Clob?&nbsp;</p><br /><br/><p>Let me share you this week's workaround.</p><br /><br/><p>Have you ever played with the thought of reading a string value larger the 4K out of a database?&nbsp;We did.</p><br /><p>We ran a query to read an XML type column with Oracle's JDBC implementation, using<br /><span style="font-family: 'courier new', courier; font-size: 10pt;"> theXmlColumn.getClobVal() </span><br />function in the select.&nbsp;On the ResultSet we used first<br /><span style="font-family: 'courier new', courier; font-size: 10pt;">rs.getString()</span>&nbsp;and later, when we experienced the strange event, we tried to use&nbsp;<br /><span style="font-family: 'courier new', courier; font-size: 10pt;">rs.getClob()</span> or<br /><span style="font-family: 'courier new', courier; font-size: 10pt;"><br /><span style="font-family: 'courier new', courier; font-size: 10pt;">rs.getAsciiStream()</span><br /></p><br /><p>All of them showed the same behaviour:&nbsp;<strong>after 4K we received a strange character</strong><br />in the string (the exact position was scattered between the 4096th to 4099th character):<br /></p><br /><p> When we printed the result out to<span style="font-family: 'courier new', courier; font-size: 10pt;"> System.<span style="color: #0000bf;">OUT</span></span><br />we could see the whole of it!&nbsp;But when we&nbsp;<strong>tried to copy paste it </strong>on my Windows 7 client, <strong>the clipboard just could not eat it, when I pressed Ctrl+V it just pasted the first 4K part of the string</strong>! Bloody hell.</p><br /><h3><strong>Jack The Reaper?</strong></h3><br /><p>What can be this slicer character? In itself it was an interesting question. I was a bit dissapointed to find out that - as usual - mystical things do not exist in software: Writing out the strange string to a file showed that<strong> the strange character was the Ascii zero character.&nbsp;</strong></p><br /><p>Seemingly the zero character is not too well behaving on Ubuntu either. I was trying to open up a small test textfile with Geany or Gedit to try out the copy-paste behaviour but they did not even open it saying the encoding is incompatible.&nbsp;</p><br /><h2><strong>The workarounds</strong></h2><br /><p>The root cause of the problem is probably around the fetching mechanism for LOBs of the Oracle JDBC driver. If you let the prepared statement know that you are dealing with a CLOB (solution 1) then it behaves well. The second option is to turn this LOB prefetching feature off.&nbsp;</p><br /><h3>Solution 1</h3><br /><p>If you have control over your prepared statement you can use:&nbsp;</p><br /><p><span style="font-family: 'courier new', courier; font-size: 10pt;">((OraclePreparedStatement) ps).defineColumnType(1, Types.LONGVARCHAR);</span></p><br /><p>There is however a more transparent solution from clean code point of view. &nbsp;</p><br /><h3>Solution 2</h3><br /><p>Setting the&nbsp;<span style="font-family: 'courier new', courier;"><a href="http://download.oracle.com/docs/cd/E11882_01/appdev.112/e13995/oracle/jdbc/OracleConnection.html#CONNECTION_PROPERTY_DEFAULT_LOB_PREFETCH_SIZE" target="_blank">DEFAULT_LOB_PREFETCH_SIZE</a>&nbsp;property to -1.&nbsp;&nbsp;</span></p><br /><blockquote><br /><p><em>The value can be "-1" to disable LOB prefetch for this connection, "0" to enable LOB prefetch for meta-data only or any value greater than 0 which represents a number of bytes for BLOBs and chars for CLOBs to be prefetched along with the locator during fetch operations. <strong>The default value for this property is "4000".</strong></em></p><br /></blockquote><br /><p>This can be done either via the OraclePreparedStatement.<a href="http://download.oracle.com/docs/cd/E11882_01/appdev.112/e13995/oracle/jdbc/OracleStatement.html#setLobPrefetchSize_int_" target="_self">setLobPrefetchSize</a>&nbsp;(but that would not be better than Solution 1) or by setting<strong><span style="font-family: 'courier new', courier; font-size: 8pt;"> oracle.jdbc.defaultLobPrefetchSize&nbsp;</span>on the connection <span style="font-family: 'courier new', courier; font-size: 8pt;">Properties </span></strong>in your Hibernate, Spring, in-line Java config.</p><br /><p><br /><span style="font-family: arial, helvetica, sans-serif; font-size: 10pt;"></span><br /></p><br />